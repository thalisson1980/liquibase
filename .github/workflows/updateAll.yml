name: Liquibase Update All

on:
  workflow_dispatch:

jobs:
  matrix_setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v3


      - name: Generate Matrix
        id: set-matrix
        run: |
          # Generate the matrix in JSON format
          matrix_string="["
          first=true
          for file in $(find migrations -type f); do
            if [ "$first" = false ]; then
              matrix_string="${matrix_string},"
            fi
            matrix_string="${matrix_string}\"$file\""
            first=false
          done
          matrix_string="${matrix_string}]"
          echo "::set-output name=matrix::$matrix_string"
          echo "$matrix_string"
        shell: bash


  perform_update:
    needs: matrix_setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        files: ${{fromJson(needs.matrix_setup.outputs.matrix)}}
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Run update
        uses: liquibase-github-actions/update@v4.23.2
        with:
          changelogFile: ${{ matrix.files }}
          url: ${{ secrets.LB_DEVOPS_URL }}
          driver: ${{ secrets.LB_DEVOPS_DRIVER }}     
          password: ${{ secrets.LB_DEVOPS_PASSWORD }}
          username: ${{ secrets.LB_DEVOPS_USER }}
          logLevel: INFO