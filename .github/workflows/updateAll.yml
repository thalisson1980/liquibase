name: Liquibase Update All

on:
  workflow_dispatch:

jobs:
  liquibase_update:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: List migration files
        run: |
          # Find all migration files in the migrations folder and store them in an array
          migration_files=($(find migrations/ -type f -name "*.sql"))

          # Iterate through the array and trigger the Liquibase Update workflow for each file
          for file in "${migration_files[@]}"; do
            echo "Processing file: $file"
            # Extract the filename without extension
            filename=$(basename -- "$file")
            filename_without_extension="${filename%.*}"
            
            run: |
              # Use the GitHub public action to run Liquibase Update
              name: Run update
              uses: liquibase-github-actions/update@v4.23.2
              with:
                changelogFile: ${{ steps.liquibase_update.outputs.changelogFile }}
                url: ${{ secrets.LB_DEVOPS_URL }}
                driver: ${{ secrets.LB_DEVOPS_DRIVER }}
                password: ${{ secrets.LB_DEVOPS_PASSWORD }}
                username: ${{ secrets.LB_DEVOPS_USER }}
                logLevel: INFO
            echo "::endgroup::"
          done
        shell: bash
